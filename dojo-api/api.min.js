/*
 dojo-api (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: http://www.dojojs.org for details
*/
var e=null;
module.exports=function(){function d(b){if(!(this instanceof d))return new d(b);/^[\w]+:\/\//.test(b)||(k="http://"+b);"/"==b.charAt(b.length-1)&&(b=b.substring(0,b.length-1));b=k.parse(b);this.protocol=b.protocol;this.hostname=b.hostname;this.port=b.port?parseInt(b.port,10):"https:"==this.protocol?443:80;this.token=this.name=e}var f=require("path"),k=require("url"),m=require("querystring"),l=require("http"),n=require("https"),h=require(f.join(__dirname,"package.json")),f=require(f.join(__dirname,"common.js")),
g=f.bcrypt;d.pkg=h;d.common=f;d.bcrypt=f.bcrypt;d.prototype.call=function(b,a,c,d){if("get"==b||"delete"==b)c&&0<Object.keys(c).length&&(a+=m.stringify(c)),c=e;c=JSON.stringify(c);b=("https:"==this.protocol?n:l).request({method:b,path:a,hostname:this.hostname,port:this.port,headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(c),"User-Agent":h.name+" "+h.version},auth:this.token!==e?this.name+":"+this.token:e},function(a){var b="",c=e;a.on("data",function(a){b+=a});a.on("error",
function(a){c=a;d(c,e)});a.on("end",function(){c===e&&(200!=a.statusCode&&(c=Error(a.statusCode+" "+l.STATUS_CODES[a.statusCode])),d(c,0<b.length?JSON.parse(b):{}))})});b.on("error",function(a){d(a,e)});b.write(c);b.end()};d.prototype.get=function(b,a,c){"function"==typeof a&&(c=a,a=e);this.call("get",b,a,c)};d.prototype.del=function(b,a,c){"function"==typeof a&&(c=a,a=e);this.call("delete",b,a,c)};d.prototype.post=function(b,a,c){this.call("post",b,a,c)};d.prototype.put=function(b,a,c){this.call("put",
b,a,c)};d.prototype.login=function(b,a,c){this.name=b;this.post("/login",{name:this.name},function(b,d){b?c(b,e):d.challenge?g.hash(a,d.challenge,function(b,d){b?c(b,e):g.genSalt(function(b,f){b?c(b,e):g.hash(a,f,function(a,b){a?c(a,e):this.post("/login",{name:this.name,response:d,update:b},function(a,b){a?c(a,b):b.token?(this.token=b.token,c(e,b)):c(Error("Missing API token"),b)}.bind(this))}.bind(this))}.bind(this))}.bind(this)):c(Error("No challenge received from server"),e)}.bind(this))};d.prototype.password=
function(b,a,c){"function"==typeof a&&(c=a,a=e);b=g.hashSync(b,g.genSaltSync());this.post("/password",{name:a?a:this.name,password:b},c)};d.prototype.list=function(b,a){"function"==typeof b&&(a=b,b=e);if(!b){if(!this.name){process.nextTick(a.bind(this,Error("Missing 'name'"),e));return}b=this.name}this.get("/apps/"+b,{},a)};d.prototype.view=function(b,a,c){"function"==typeof a&&(c=a,a=e);if(!a){if(!this.name){process.nextTick(c.bind(this,Error("Missing 'name'"),e));return}a=this.name}this.get("/apps/"+
a+"/"+b,{},c)};d.prototype.start=function(b,a,c){"function"==typeof a&&(c=a,a=e);if(!a){if(!this.name){process.nextTick(c.bind(this,Error("Missing 'name'"),e));return}a=this.name}this.post("/apps/"+a+"/"+b+"/start",{},c)};d.prototype.restart=function(b,a,c){"function"==typeof a&&(c=a,a=e);if(!a){if(!this.name){process.nextTick(c.bind(this,Error("Missing 'name'"),e));return}a=this.name}this.post("/apps/"+a+"/"+b+"/restart",{},c)};d.prototype.stop=function(b,a,c){"function"==typeof a&&(c=a,a=e);if(!a){if(!this.name){process.nextTick(c.bind(this,
Error("Missing 'name'"),e));return}a=this.name}this.post("/apps/"+a+"/"+b+"/stop",{},c)};d.prototype.deploy=function(b,a,c){"function"==typeof a&&(c=a,a=e);this.put("/apps/"+this.name,b,function(b,d){b?c(b,e):"error"in d?c(Error("Illegal package definition: "+d.error),d):a?c(Error("Not yet implemented"),e):this.post("/apps/"+this.name+"/"+d.name+"/start",{},c)})};d.prototype.purge=function(b,a,c){"function"==typeof a&&(c=a,a=e);if(!a){if(!this.name){process.nextTick(c.bind(this,Error("Missing 'name'"),
e));return}a=this.name}this.del("/apps/"+a+"/"+b,{},c)};d.prototype.addUser=function(b,a,c){a=g.hashSync(a,g.genSaltSync());this.put("/users",{name:b,password:a},c)};d.prototype.delUser=function(b,a){this.del("/users/"+b,{},a)};d.prototype.suspend=function(b,a){this.post("/users/"+b+"/suspend",{},a)};d.prototype.activate=function(b,a){this.post("/users/"+b+"/activate",{},a)};d.prototype.toString=function(){return"dojo-api-"+h.version+":"+(this.protocol+"//"+(this.name!==e?this.name+"@":"")+this.hostname+
":"+this.port)};return d.Client=d}();
